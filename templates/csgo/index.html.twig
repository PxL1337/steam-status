{% extends 'base.html.twig' %}

{% block title %}CS2 Status{% endblock %}

{% block body %}

    <div class="steam-green"
         data-controller="auto-refresh theme-switch"
         data-auto-refresh-interval-value="60"
    >
        <div class="container-fluid py-3">
            <!-- Barre du haut : Titre, Switch Theme, auto-refresh -->
            <div class="row align-items-center mb-3">
                <div class="col">
                    <h1 class="mb-0">CS2 Status</h1>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-secondary"
                            data-action="theme-switch#toggleTheme">
                        Switch Theme
                    </button>
                </div>
                <div class="col-auto">
                    {# Indicateur auto-refresh plus visible #}
                    <span class="text-white me-2" style="font-weight: bold;">
                        Rafraîchissement dans
                    </span>
                    <span class="auto-refresh-badge">
                        <span data-auto-refresh-target="countdown">60</span> s
                    </span>
                </div>
            </div>


            <!-- Carte “Informations générales” -->
            <div class="card mb-4">
                <div class="card-header">Informations générales</div>
                <div class="card-body">

                    <!-- Encart 1: FetchedAt / AppVersion en 2 colonnes -->
                    <div class="row text-center mb-4">
                        <div class="col-md-6">
                            <p>
                                <strong>Last update:</strong>
                                {{ csgo.fetchedAt|date('D-M-Y H:i:s') }}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <strong>App Version:</strong>
                                {{ csgo.appVersion }}
                            </p>
                        </div>
                    </div>

                    <!-- Informations générales -->
                    <div class="row text-center">
                        {% for serviceName, serviceValue in {
                            'Scheduler': data.matchmaking.scheduler,
                            'SessionsLogon': data.services.SessionsLogon,
                            'SteamCommunity': data.services.SteamCommunity,
                            'Leaderboards': data.services.Leaderboards
                        } %}
                            <div class="col-md-6 mb-3">
                                <div class="card service-status-card">
                                    <div class="card-header">{{ serviceName }}</div>
                                    <div class="card-body">
                                        {% set statusClass = '' %}
                                        {% set iconName = '' %}

                                        {% if serviceValue in ['normal', 'online', 'full'] %}
                                            {% set statusClass = 'load-low' %}
                                            {% set iconName = 'prime:check-circle' %}
                                        {% elseif serviceValue in ['partial'] %}
                                            {% set statusClass = 'load-medium' %}
                                            {% set iconName = 'iconoir:warning-circle' %}
                                        {% elseif serviceValue in ['offline', 'high'] %}
                                            {% set statusClass = 'load-high' %}
                                            {% set iconName = 'line-md:close-circle' %}
                                        {% else %}
                                            {% set statusClass = 'load-idle' %}
                                            {% set iconName = 'mingcute:sleep-fill' %}
                                        {% endif %}

                                        <span class="{{ statusClass }} d-inline-flex align-items-center">
                        <twig:ux:icon name="{{ iconName }}" class="icon-gauge me-1"/>
                        {{ serviceValue|capitalize }}
                    </span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                </div>
            </div>

            <!-- Carte Matchmaking: 2x2 => (Players | Servers), (Searching | Average) -->
            <div class="card mb-4">
                <div class="card-header">Matchmaking</div>
                <div class="card-body">

                    <div class="row">
                        <!-- top-left: Online Players -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">
                                Online Players:
                                <strong>{{ data.matchmaking.online_players }}</strong>
                            </h5>
                            {{ render_chart(chartPlayers) }}
                        </div>

                        <!-- top-right: Online Servers -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">
                                Online Servers:
                                <strong>{{ data.matchmaking.online_servers }}</strong>
                            </h5>
                            {{ render_chart(chartServers) }}
                        </div>
                    </div>

                    <div class="row">
                        <!-- bottom-left: Searching Players -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">
                                Searching Players:
                                <strong>{{ data.matchmaking.searching_players }}</strong>
                            </h5>
                            {{ render_chart(chartSearching) }}
                        </div>

                        <!-- bottom-right: Search Average -->
                        <div class="col-md-6 mb-4">
                            <h5 class="text-center">
                                Search Average:
                                <strong>{{ data.matchmaking.search_seconds_avg }}s</strong>
                            </h5>
                            {{ render_chart(chartSearchAvg) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datacenters (par région) -->
            <div class="card mb-4">
                <div class="card-header">Datacenters (par région)</div>
                <div class="card-body">
                    <table class="datacenters-table">
                        <thead>
                        <tr>
                            <th>Region</th>
                            <th>Capacity</th>
                            <th>Load</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for regionName, datacenters in groupedDatacenters %}
                            {% if datacenters is not empty %}
                                <tr class="table-secondary">
                                    <td colspan="3">
                                        <strong>{{ regionName }}</strong>
                                    </td>
                                </tr>
                                {% for dc in datacenters %}
                                    <tr>
                                        <td>
                                            {% if dc.flag %}
                                                <span class="fi fi-{{ dc.flag }}" style="margin-right:6px;"></span>
                                            {% endif %}
                                            {% if dc.city %}{{ dc.city }}{% else %}{{ dc.country }}{% endif %}
                                        </td>
                                        {# Dans la colonne Capacity, on insère un <twig:ux:icon> selon la valeur #}
                                        <td>
                                            {% if dc.capacity == 'full' %}
                                                <span class="badge bg-success d-inline-flex align-items-center">
                                                    <twig:ux:icon name="prime:check-circle" class="icon-gauge me-1" />
                                                    Full
                                                </span>
                                            {% elseif dc.capacity == 'partial' %}
                                                <span class="badge bg-warning text-dark d-inline-flex align-items-center">
                                                    <twig:ux:icon name="line-md:warning-circle" class="icon-gauge me-1" />
                                                    Partial
                                                </span>
                                            {% elseif dc.capacity %}
                                                <span class="badge bg-dark d-inline-flex align-items-center">
                                                    <twig:ux:icon name="line-md:question-circle" class="icon-gauge me-1" />
                                                    {{ dc.capacity }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary d-inline-flex align-items-center">
                                                    <twig:ux:icon name="line-md:question-circle" class="icon-gauge me-1" />
                                                    N/A
                                                </span>
                                            {% endif %}
                                        </td>

                                        <td>
                                            {# load (Idle, Low, Medium, High) => icônes line-md #}
                                            {% if dc.load == 'idle' %}
                                                <span class="badge bg-info d-inline-flex align-items-center">
                                                <twig:ux:icon name="line-md:gauge-empty" class="icon-gauge me-1" />
                                                Idle
                                            </span>
                                            {% elseif dc.load == 'low' %}
                                                <span class="badge bg-success d-inline-flex align-items-center">
                                                <twig:ux:icon name="line-md:gauge-low" class="icon-gauge me-1" />
                                                Low
                                            </span>
                                            {% elseif dc.load == 'medium' %}
                                                <span class="badge bg-warning text-dark d-inline-flex align-items-center">
                                                <twig:ux:icon name="line-md:gauge" class="icon-gauge me-1" />
                                                Medium
                                            </span>
                                            {% elseif dc.load == 'high' %}
                                                <span class="badge bg-danger d-inline-flex align-items-center">
                                                <twig:ux:icon name="line-md:gauge-full" class="icon-gauge me-1" />
                                                High
                                            </span>
                                            {% else %}
                                                <span class="badge bg-secondary d-inline-flex align-items-center">
                                                <twig:ux:icon name="line-md:gauge" class="icon-gauge me-1" />
                                                {{ dc.load }}
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
{% endblock %}
